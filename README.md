# Анализ слайсера Skeinforge
В данном репозитории содержится обзор функционала слайсера Skeinforge и его кода.
## Использование слайсера 
Skeinforge (далее СФ) содержит большое количество настроек для слайсинга и печати, - от настройки толщины слайса вплоть до настроек формы и угла поворота при заполнении.
Загрузим модельку кораблика Бенчи со стандартными параметрами: 
![image](https://github.com/Zysperro/SkeinForgeAnalysis/assets/110100353/f1ba193e-c572-453a-ae7f-bdf92bfb9d21)

На картинке выше виден 5 слой слайснутой модели. Стандартно используется паттерн заполнения прямыми линиями, что видно на картинке.
Среди слоев даже затесалась реклама:
![image](https://github.com/Zysperro/SkeinForgeAnalysis/assets/110100353/554eed10-379e-434b-aef9-10722e08eea3)

При использовании параметра Infill Pattern: Grid Hexagonal, заполнение внутренних полостей будет происходить не сплошными линиями, а шестиугольниками (гексагонами):

![image](https://github.com/Zysperro/SkeinForgeAnalysis/assets/110100353/63a9bc21-3688-4757-84e6-ce682c0df866)
![image](https://github.com/Zysperro/SkeinForgeAnalysis/assets/110100353/d5d325ed-46f4-4fdc-9ff7-5b79ae0da01c)

> <sub>Полученный gcode файл - в репозитории (3DBenchy_export.gcode)</sub>

Основные инструменты программы для слайсинга находятся в папке skeinforge_plugins/craft_plugins, рассмотрим в параметрах профиля порядок создания gcode модели, мы рассматриваем печать 3Д принтеорм, поэтому заглянем в модуль extrusion.py в profile_plugins:
![image](https://github.com/Zysperro/SkeinForgeAnalysis/assets/110100353/3a45b6fc-d579-41c7-bd88-132bf8022eb6)

Порядок следующий:
> carve scale bottom preface widen inset fill multiply speed temperature raft skirt chamber tower jitter clip smooth stretch skin comb cool hop wipe oozebane dwindle splodge home lash fillet limit unpause dimension alteration export

После нажатия кнопки Skeinforge и выбора файла, начинается работа по слайсингу, запускается метод skeinforge.py/execute()
Далее в skeinforge_craft.py загружается порядок выполнения из profile_plugins и начинается выполнение модулей по порядку.

Рассмотрим эти модули по отдельности:

### Carve
Carve вырезает форму в слои svg слайсов. Он также задает высоту слоя и ширину края для остальных инструментов.

Запускается стандартным для других модулей writeOutput(fileName, shouldAnalyze=True), получая ссылку на файл, с которым необходимо работать. После загрузки, установки настроек и инициализации необходимых библиотек, запускается getCraftedText. Из модуля fabmetheus_utilities, в частности из svg_writer, получаем треугольную сетку. Для разных форматов - свой скрипт, рассмотрим скрипт для stl:

```Python
def getCarving(fileName=''):
	"Get the triangle mesh for the stl file."
	if fileName == '':
		return None
	stlData = archive.getFileText(fileName, True, 'rb') # Читаем файл
	if stlData == '':
		return None
	triangleMesh = triangle_mesh.TriangleMesh() # Создаем треугольную сетку (разновидность полигональной)
	vertexIndexTable = {} # Тарбилца с вершинами треугольников сетки
	numberOfVertexStrings = stlData.count('vertex') # Кол-во этих самых треугольников
	requiredVertexStringsForText = max( 2, len( stlData ) / 8000 )
  # Далее по сути строится список треугольников (faces, она же n-мерная грань) из векторов (строки с координатами вершин разбиваются на 3-мерные вектора)
	if numberOfVertexStrings > requiredVertexStringsForText:
		addFacesGivenText( stlData, triangleMesh, vertexIndexTable )
	else:
		addFacesGivenBinary( stlData, triangleMesh, vertexIndexTable )
	return triangleMesh
  
def addFacesGivenText( stlText, triangleMesh, vertexIndexTable ):
	"Add faces given stl text."
	lines = archive.getTextLines( stlText )
	vertexes = []
	for line in lines:
		if line.find('vertex') != - 1:
			vertexes.append( getVertexGivenLine(line) )
	addFacesGivenVertexes( triangleMesh, vertexIndexTable, vertexes )
  
 def getVertexGivenLine(line):
	"Get vertex given stl vertex line."
	splitLine = line.split()
	return Vector3( getFloat(splitLine[1]), getFloat( splitLine[2] ), getFloat( splitLine[3] ) ) 
  
 def addFacesGivenVertexes( triangleMesh, vertexIndexTable, vertexes ):
	"Add faces given stl text."
	for vertexIndex in xrange( 0, len(vertexes), 3 ):
		triangleMesh.faces.append( getFaceGivenLines( triangleMesh, vertexIndex, vertexIndexTable, vertexes ) )
```

Затем вызывается getCarvedSVG(self, carving (наш triangle_mesh), fileName, repository (настройки)) из внутреннего класса CarveSkein: 
Там происходит загрузка настроек из нашей переменной и из нашего меша и затем запуск преобразования в SVG файл, здесь самое важное: получение наших слайсов (слоев) из библиотеки Trinagle_Mesh:
```Python
loopLayers = carving.getCarveBoundaryLayers()
# Также слои усекаются на основании параметров repository.layersFrom repository.layersTo
truncatedRotatedBoundaryLayers = svg_writer.getTruncatedRotatedBoundaryLayers(loopLayers, repository)
```

Так мы получили наш svg

### Scale
Scale масштабирует карвинг(вырезку?), чтобы компенсировать усадку после охлаждения экструзии (материала).
По сути код просто проходится по слоям и умножает координаты на указанный масштаб (стандартно 1.01 для XY и 1 для Z):
![image](https://github.com/Zysperro/SkeinForgeAnalysis/assets/110100353/bb258eb0-ee85-4ca3-924d-0d82f711c1a0)

Сам цикл:
![image](https://github.com/Zysperro/SkeinForgeAnalysis/assets/110100353/d32204dc-3c2b-400b-9305-84f09dc321a0)

### Bottom
Bottom устанавливает дно вырезки на заданную высоту.
Здесь также просто добавляется дельта высоты (для чего находить min между максимальным числом и z - непонятно, возможно чтобы число было не больше максимума):

![image](https://github.com/Zysperro/SkeinForgeAnalysis/assets/110100353/8e3be56d-2661-4c61-a148-78a5ad78b32a)

### Preface
Preface преобразует svg-фрагменты в экструзионные (печатные?) слои gcode.
Preface содержит сборку gcode, добавление команды выключение экструдера
![image](https://github.com/Zysperro/SkeinForgeAnalysis/assets/110100353/ee35c01a-9d6f-40c5-9221-feaa0d2aa218)

Добавление preface на слои:
![image](https://github.com/Zysperro/SkeinForgeAnalysis/assets/110100353/d0dcbbb7-dede-483e-978e-64fd7fbfbc1e)



### Widen
Расширитель расширяет внешние края по отношению к внутренним, так что внешние края будут отдалены от внутренних по крайней мере на две ширины, и поэтому внешние нити не будут перекрывать внутренние.
Например, если кружка имеет очень тонкую стенку, то расширитель расширит внешнюю сторону кружки так, что стенка кружки будет иметь ширину в два края, и нить внешней стенки не будет пересекаться со внутренней.
Или, например, если внешняя сторона объекта проходит рядом с отверстием, то расширитель расширит стенки вокруг отверстия так, что стенка будет выпуклой вокруг отверстия, а внешняя нить не будет перекрывать нить отверстия.
В основном методе addWiden код проходится по всем лупам слоя и находит пересечения 
![image](https://github.com/Zysperro/SkeinForgeAnalysis/assets/110100353/24fff58b-4919-466f-950b-b7ca16b4a005)

Метод для нахождения пересечениий:
![image](https://github.com/Zysperro/SkeinForgeAnalysis/assets/110100353/d238a580-63a8-4836-a778-7d4c40484aa5)

Для нахождения используются метод из библиотеки fabmetheus_utilities - euclidean.isPathInsideLoop

Далее пересекаемые пути объединияются:
![image](https://github.com/Zysperro/SkeinForgeAnalysis/assets/110100353/11424028-0660-4feb-84c8-4568f8673819)

### Inset
Inset углубляет внешние контуры на половину ширины края, и внутренние - на столько же. 

### Fill
Fill заполняет фигуру.

### Multiply
Multiply умножает объекты, преобразует один объект в массив объектов. Используется, если необходимо напечатать несколько одинаковых объектов за один проход.

### Speed
В Speed выставляются скорость подачи (feed rate) и скорость расхода (flow rate).

### Termperature
Termperature говорит за себя - выставляются параметры температуры материала.

### Raft
Raft - это плагин для создания "плота"(Raft - плот). Плот - это плоская базовая структура, на которой строится объект, она имеет несколько различных целей. Плот заполняет неровности, такие как царапины и ямы на печатном поле, и обеспечивает хорошее основание, параллельное движению печатающих головок. Он также приклеивает объект к основанию, чтобы предотвратить деформацию объекта. Базовый слой плота выполняет эти функции, а более редкие интерфейсные слои помогают легче оторвать объект с плота после печати.  Он основан на многоразовом плоте Nophead, который имеет базовый слой, идущий в одну сторону, и пару перпендикулярных слоев выше.  Каждый слой может быть настроен на разную температуру.  Есть возможность заставить экструдер остановиться на некоторое время, чтобы ствол нагревателя успел достичь другой температуры, не накапливая грязь вокруг сопла.

### Skirt
Skirt - это плагин, позволяющий дать экструдеру дополнительное время для правильного начала экструзии перед началом печати объекта, а также построить перегородку вокруг модели, чтобы сохранить экструзию теплой.

### Chamber
Некоторые наполнители слишком сильно сжимаются и деформируют напечатанный объект.  Чтобы предотвратить это, необходимо печатать объект в камере с регулируемой температурой и/или на рабочей поверхности с регулируемой температурой. Chamber tool позволяет контролировать температуру поверхности и камеры, а также давление прижима.

### Tower
Tower дает команду экструдеру печатать отсоединенную область на несколько слоев, затем перейти к другой отсоединенной области и выдавливать там.  Его цель - уменьшить количество стрингеров (шлаковых строчечных включений) между формами и сократить перемещение экструдера.
Т.е. используется для поддержки consistency (одинаковости) между отдаленными частями, и чтобы сопло не засыхало и не было "шлаковых строчечных включений" - т.е. мусора в выдавленном материале, для этого Tower дает команду печатать ближайшие не соедененные части.

### Jitter
Jitter смещает положение конца петли (лупа) в другое место на каждом слое, чтобы предотвратить образование горба на боковой стороне объекта. (Я так понимаю, чтобы 

### Clip
Clip - "зажимает" концы лупов, соединяет их концы так, чтобы не было неровностей. Т.е. один слой накладывает на другой так, чтобы не было пустых мест(---=--- лучше, чем --- ---)

### Smooth
Этот плагин "сглаживает" неровные траектории движения экструдера. Он прокладывает короткие пути через неровные траектории и уменьшает скорость подачи для компенсации.

### Stretch
Stretch позволяет частично компенсировать тот факт, что напечатанные отверстия меньше, чем должны быть. Он растягивает нити, чтобы частично компенсировать усадку нити при печати.

### Comb
Comb позволяет огибать траектории движения экструдера вокруг отверстий в слоях, чтобы избежать шлаковых включений. (т.е. сопло не будет бездействовать, проходя над отверстием, а будет его огибать)

### Cool
Охлаждение детали

### Hop
Hop поднимает экструдер, когда тот не работает

### Wipe
Очистка сопла. Двигает сопло на спец. точку для очистки ("вытирания"), очистка зависит от принтера.

### Oozebane
Oozebane это не модуль в честь кого-то с фамилией "Узбейн", это "бич подтечек". Выключает экструдер до окончания операции и включает его до начала.

### Dwindle
Также предназначен для уменьшения подтечек, уменьшает скорость подачи и расхода под конец операции. Уменьшает скорость подачи сильнее, чем расхода.

### Splodge
Splodge включает экструдер немного перед началом операции, чтобы у новый слой сразу немного закрепился на прошлом.

### Home
Home возвращает экструдер в начальную точку.

### Lash
Lash частично компенсирует люфт головки экструдера.

### Fillet
Fillet слегка скругляет углы. Это делается для уменьшения раздувания углов и резкого ускорения экструдера.

### Limit
Ограничивает скорость подачи и расхода.

### Unpause
Компенсирует задержку микропроцессора.

### Export
Экспорт, выбор плагина для экспорта.

